name: PR Preview with Surge.sh

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    # Don't run this job if the PR is closed AND the event is "closed"
    if: github.event.action != 'closed'
    uses: ./.github/workflows/shared-build.yml
    with:
      deploy_to_surge: true
      pr_number: ${{ github.event.pull_request.number }}
    secrets:
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      SURGE_LOGIN: ${{ secrets.SURGE_LOGIN }}

  comment-on-pr:
    needs: deploy-preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Preview Deployed

              Your PR is now available for review at: [${needs.deploy-preview.outputs.preview_url}](${needs.deploy-preview.outputs.preview_url})

              This URL will remain active until the PR is closed or merged.`
            });

  cleanup-preview:
    runs-on: ubuntu-latest
    # Only run this job when the PR is closed
    if: github.event.action == 'closed'

    steps:
      - name: Cache Surge
        uses: actions/cache@v4
        id: surge-cache
        with:
          path: ~/.npm-global
          key: ${{ runner.os }}-surge-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-surge-

      - name: Setup Surge global install directory
        if: steps.surge-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.npm-global
          npm config set prefix '~/.npm-global'
          echo "~/.npm-global/bin" >> $GITHUB_PATH

      - name: Install Surge
        if: steps.surge-cache.outputs.cache-hit != 'true'
        run: npm install -g surge

      - name: Add Surge to PATH
        if: steps.surge-cache.outputs.cache-hit == 'true'
        run: echo "~/.npm-global/bin" >> $GITHUB_PATH

      - name: Teardown Surge deployment
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
          SURGE_LOGIN: ${{ secrets.SURGE_LOGIN }}
        run: |
          # Crear archivo .netrc para autenticaciÃ³n
          echo "machine surge.surge.sh" > ~/.netrc
          echo "login $SURGE_LOGIN" >> ~/.netrc
          echo "password $SURGE_TOKEN" >> ~/.netrc
          chmod 600 ~/.netrc
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          DOMAIN="pr-${PR_NUMBER}-${REPO_NAME}.surge.sh"
          surge teardown $DOMAIN

      - name: Comment PR Cleanup
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§¹ Preview Removed

              The preview for this PR has been removed since the PR has been ${context.payload.pull_request.merged ? 'merged' : 'closed'}.`
            });
