---
import HeadBase from "@astrojs/starlight/components/Head.astro";
import { detectEnvironment } from "../../../config/environment.js";

// Define interfaces for better type safety
interface MetaTag {
  tag: string;
  attrs: {
    property?: string;
    name?: string;
    content?: string;
    [key: string]: string | undefined;
  };
  content?: string;
}

// Get page info from the props passed by Starlight
const { head: originalHead = [], page } = Astro.props;

// Get environment information
const env = detectEnvironment();
const { siteUrl = "" } = env as { siteUrl: string };

// Ensure siteUrl is not empty, fallback to production URL if needed
const baseUrl = siteUrl || "https://interview.signlanguagetech.com";

// -------------------------------------------------------
// Define fallback values
// -------------------------------------------------------
const defaultTitle = "Sign Tech Interview";
const defaultDescription = "Comprehensive guide for technical interviews covering various programming languages and software development concepts.";

// Get the current page title and description from the page data
const pageTitle = page?.data?.title || defaultTitle;
const pageDescription = page?.data?.description || defaultDescription;

// Check if OG tags already exist
const hasOgTag = (property: string) =>
  originalHead.some((tag: MetaTag) => tag.attrs?.property === property);

const hasOgImage = hasOgTag("og:image");
const hasOgLogo = hasOgTag("og:logo");
const hasTwitterCard = hasOgTag("twitter:card");
const hasTwitterSite = hasOgTag("twitter:site");
const hasTwitterTitle = hasOgTag("twitter:title");
const hasTwitterDescription = hasOgTag("twitter:description");
const hasTwitterImage = hasOgTag("twitter:image");

// Ensure we have absolute URLs for images
const logoUrl = new URL("/logo.png", baseUrl).toString();

// -------------------------------------------------------
// Add custom meta tags that don't exist in the original head
// -------------------------------------------------------
const customHead = [
  // Standard meta tags
  { tag: "meta", attrs: { name: "description", content: pageDescription } },
  
  // Open Graph
  { tag: "meta", attrs: { property: "og:title", content: pageTitle } },
  { tag: "meta", attrs: { property: "og:description", content: pageDescription } },
  { tag: "meta", attrs: { property: "og:image", content: logoUrl } },
  { tag: "meta", attrs: { property: "og:logo", content: logoUrl } },
  { tag: "meta", attrs: { property: "og:image:type", content: "image/png" } },
  { tag: "meta", attrs: { property: "og:image:alt", content: "Sign Tech Interview Logo" } },
  
  // Twitter Card
  { tag: "meta", attrs: { name: "twitter:card", content: "summary_large_image" } },
  { tag: "meta", attrs: { name: "twitter:site", content: "@SignLanguageTech" } },
  { tag: "meta", attrs: { name: "twitter:title", content: pageTitle } },
  { tag: "meta", attrs: { name: "twitter:description", content: pageDescription } },
  { tag: "meta", attrs: { name: "twitter:image", content: logoUrl } },
  { tag: "meta", attrs: { name: "twitter:image:alt", content: "Sign Tech Interview Logo" } },
];

// Filter out custom tags that already exist in the originalHead
const existingProperties = new Set<string>();
const existingNames = new Set<string>();

originalHead.forEach((tag: MetaTag) => {
  if (tag.attrs?.property) existingProperties.add(tag.attrs.property);
  if (tag.attrs?.name) existingNames.add(tag.attrs.name);
});

const additionalHead = customHead.filter((tag: MetaTag) => {
  if (tag.attrs?.property) return !existingProperties.has(tag.attrs.property);
  if (tag.attrs?.name) return !existingNames.has(tag.attrs.name);
  return true;
});

// Combine original head with our additional tags
const mergedHead = [...originalHead, ...additionalHead];

---

<HeadBase head={mergedHead} />

<!-- Add critical OG tags only if missing -->
{!hasOgImage && <meta property="og:image" content={`${siteUrl}/logo.png`} />}
{!hasOgLogo && <meta property="og:logo" content={`${siteUrl}/logo.png`} />}


<!-- Add Twitter Card tags if missing -->
{!hasTwitterCard && <meta name="twitter:card" content="summary_large_image" />}
{!hasTwitterSite && <meta name="twitter:site" content="@SignLanguageTech" />}
{
  !hasTwitterTitle && (
    <meta
      name="twitter:title"
      content={
        originalHead.find((tag: MetaTag) => tag.attrs?.property === "og:title")
          ?.attrs?.content || "Sign Tech Interview"
      }
    />
  )
}
{
  !hasTwitterDescription && (
    <meta
      name="twitter:description"
      content={
        originalHead.find(
          (tag: MetaTag) => tag.attrs?.property === "og:description",
        )?.attrs?.content || ""
      }
    />
  )
}
{
  !hasTwitterImage && (
    <meta name="twitter:image" content={`${siteUrl}/logo.png`} />
  )
}

<!-- Add additional OG image metadata -->
{
  !hasOgTag("og:image:type") && (
    <meta property="og:image:type" content="image/png" />
  )
}
{
  !hasOgTag("og:image:alt") && (
    <meta property="og:image:alt" content="Sign Tech Interview Logo" />
  )
}